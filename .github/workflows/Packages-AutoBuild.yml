name: Packages-AutoBuild

on:
  workflow_dispatch:
  push:
    branches: [ main ]
env:
  TZ: Asia/Shanghai

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        target: [aarch64_cortex-a53, arm_cortex-a7_neon-vfpv4, x86_64]

    steps:
    - name: Checkout
      uses: actions/checkout@v5
      with:
        fetch-depth: 0

    - name: Free disk space
      uses: coder-xiaomo/free-disk-space@main
      with:
        tool-cache: false
        android: true
        dotnet: true
        haskell: true
        large-packages: true
        docker-images: true
        swap-storage: true

    - name: Initialization environment
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo -E apt-get -qq update
        sudo -E apt-get -qq install build-essential libncurses-dev zlib1g-dev gawk git \
        gettext libssl-dev xsltproc rsync wget unzip \
        llvm python3-pyelftools libpython3-dev aria2 jq qemu-utils rename \
        libelf-dev libgmp3-dev libmpc-dev libfuse-dev bc autopoint cups-ppdc
        sudo -E apt-get -qq autoremove --purge
        sudo -E apt-get -qq clean
        sudo timedatectl set-timezone "Asia/Shanghai"

    - name: Get current date
      id: date
      run: |
        echo "date=$(date +'%m/%d_%Y_%H/%M')" >> $GITHUB_ENV
        echo "date2=$(date +'%m/%d %Y')" >> $GITHUB_ENV
        echo "date3=$(date +'%m.%d')" >> $GITHUB_ENV

#    - name: Clone source code
#      run: |
#        set -v
#        REPO_BRANCH="24.10-SNAPSHOT"
#        echo "$REPO_BRANCH"
#        if [ ${{matrix.target}} == "x86_64" ]; then
#            curl -fL -o sdk.tar.zst https://downloads.openwrt.org/releases/$REPO_BRANCH/targets/x86/64/openwrt-sdk-$REPO_BRANCH-x86-64_gcc-13.3.0_musl.Linux-x86_64.tar.zst
#        elif [ ${{matrix.target}} == "aarch64_cortex-a53" ]; then
#            curl -fL -o sdk.tar.zst https://downloads.openwrt.org/releases/$REPO_BRANCH/targets/qualcommax/ipq807x/openwrt-sdk-$REPO_BRANCH-qualcommax-ipq807x_gcc-13.3.0_musl.Linux-x86_64.tar.zst
#        elif [[ ${{matrix.target}} == "arm_cortex-a7_neon-vfpv4" ]]; then
#            curl -fL -o sdk.tar.zst https://downloads.openwrt.org/releases/$REPO_BRANCH/targets/ipq40xx/generic/openwrt-sdk-$REPO_BRANCH-ipq40xx-generic_gcc-13.3.0_musl_eabi.Linux-x86_64.tar.zst
#        fi
        
    - name: Download OpenWrt SDK
      run: |
        case ${{ matrix.target }} in
          aarch64_cortex-a53)
            SDK_URL="https://downloads.openwrt.org/releases/24.10-SNAPSHOT/targets/qualcommax/ipq807x/openwrt-sdk-24.10-SNAPSHOT-qualcommax-ipq807x_gcc-13.3.0_musl.Linux-x86_64.tar.zst"
            ;;
          arm_cortex-a7_neon-vfpv4)
            SDK_URL="https://downloads.openwrt.org/releases/24.10-SNAPSHOT/targets/ipq40xx/generic/openwrt-sdk-24.10-SNAPSHOT-ipq40xx-generic_gcc-13.3.0_musl_eabi.Linux-x86_64.tar.zst"
            ;;
          x86_64)
            SDK_URL="https://downloads.openwrt.org/releases/24.10-SNAPSHOT/targets/x86/64/openwrt-sdk-24.10-SNAPSHOT-x86-64_gcc-13.3.0_musl.Linux-x86_64.tar.zst"
            ;;
        esac
        curl -fL -o sdk.tar.zst "$SDK_URL"
        sudo mkdir -p -m 777 openwrt
        tar --zstd -xf sdk.tar.zst -C openwrt --strip-components=1

#    - name: Free up disk space
#      env:
#        DEBIAN_FRONTEND: noninteractive
#      run: |
#        sudo mkdir -p -m 777 openwrt /mnt/openwrt/staging_dir /mnt/openwrt/build_dir /mnt/openwrt/bin  /mnt/openwrt/dl
#        if [[ "$(echo "${{github.event.action}}" | grep "a-")" ]]; then
#          ln -sf /mnt/openwrt/staging_dir openwrt/staging_dir
#          ln -sf /mnt/openwrt/bin openwrt/bin
#          ln -sf /mnt/openwrt/dl openwrt/dl
#          ln -sf /mnt/openwrt/build_dir openwrt/build_dir
#        fi
#        df -hT

    - name: Copy packages
      run: |
        cp -r * openwrt/package/ || true

    - name: Compile packages
      run: |
        cd openwrt
        cp -rf ./openwrt-sdk*/. ./ 2>/dev/null || true
        cp -rf ./openwrt-sdk*/build_dir/. ./build_dir/ || true
        cp -rf ./openwrt-sdk*/staging_dir/. ./staging_dir/ || true
        make defconfig
        make package/compile -j$(nproc) V=s

    - name: Generate feed index
      run: |
        mkdir -p artifacts/${{ matrix.target }}
        PKG_DIR="artifacts/${{ matrix.target }}"
        # æ”¶é›†æ‰€æœ‰ ipk
        find openwrt/bin/packages/ -name "*.ipk" -exec cp {} $PKG_DIR/ \;
        cd $PKG_DIR
        # ç”Ÿæˆ Packages ç´¢å¼•
        opkg-make-index . > Packages
        gzip -9nc Packages > Packages.gz
        cp Packages Packages.manifest

    - name: Sign feed index
      run: |
        cd artifacts/${{ matrix.target }}
        echo "${{ secrets.USIGN_SECRET }}" > usign.key
        openwrt/staging_dir/host/bin/usign -S -m Packages -s usign.key -x Packages.sig
        rm -f usign.key

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      if: github.ref == 'refs/heads/main'
      with:
        tag_name: packages-${{ github.run_number }}
        name: "Packages Build #${{ github.run_number }} ğŸš€"
        body: |
          è‡ªåŠ¨æ„å»ºçš„ OpenWrt åŒ…åˆé›†
          - æ¶æ„: ${{ matrix.target }}
          - æ—¶é—´: $(date +'%Y-%m-%d %H:%M:%S')
        files: artifacts/${{ matrix.target }}/*
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
